#!/usr/bin/env bash
set -eo pipefail; [[ $DOKKU_TRACE ]] && set -x

source "$PLUGIN_CORE_AVAILABLE_PATH/common/functions"

verify_app_name "$1"

if [[ -f "$DOKKU_ROOT/NOTIFY_URL" ]]; then
  echo "-----> Notifying ..."
  NOTIFY_URL=$(cat "$DOKKU_ROOT/NOTIFY_URL" 2> /dev/null)
  HOSTNAME=$(hostname)
  GIT_REV=$(GIT_DIR=$DOKKU_ROOT/$APP git rev-parse HEAD)
  PUBLIC_IP=$(LANG=c ifconfig eth0 | grep "inet addr" | awk -F: '{print $2}' | awk '{print $1}')

  NOTIFY_JSON="{ \
    \"revision\": \"$GIT_REV\", \
    \"hostname\": \"$HOSTNAME\", \
    \"args\": \"$PUBLIC_IP\" \
  }"
  echo "       ${NOTIFY_JSON}"
  CURL_RESULT=$(curl -s -d "payload=$NOTIFY_JSON" "${NOTIFY_URL}" -w "%{http_code}" 2> /dev/null)
  echo "       ${CURL_RESULT}"
fi
